# Diki compliance issues

This document shows the required requests needed to be sent for `Diki` findings to be created as GitHub issues via `delivery-service`.

> [!IMPORTANT]  
> The endpoints listed in this document were extracted from the [REST-API-Documentation](../../README.md#rest-api-documentation).

## Creating Diki compliance issues

To have `Diki` issues generated by the issue replicator we need to upload the `Diki` findings to the delivery database and to create a specific `CR` in the `ocm-gear` cluster.

To push `Diki` findings we can make a `PUT` request to the `/artefacts/metadata` endpoint of `delivery-service`.
The request body should contain a list of `entries`, one of which should be of type `meta/artefact_scan_info`.
`Diki` findings are separated by rule in `finding/diki` type:

``` json
{
  "entries": [
    {
      "artefact": {
        "component_name": "<component_name>",
        "component_version": "<component_version>",
        "artefact_kind": "runtime",
        "artefact": {
          "artefact_name": "<artefact_name>",
          "artefact_version": "diki",
          "artefact_type": "dikiReport"
        }
      },
      "meta": {
        "type": "meta/artefact_scan_info",
        "datasource": "diki"
      },
      "data": {}
    },
    {
      "artefact": {
        "component_name": "<component_name>",
        "component_version": "<component_version>",
        "artefact_kind": "runtime",
        "artefact": {
          "artefact_name": "<artefact_name>",
          "artefact_version": "diki",
          "artefact_type": "dikiReport"
        }
      },
      "meta": {
        "type": "finding/diki",
        "datasource": "diki"
      },
      "discovery_date": "<YYYY-MM-DD>",
      "data": {
        "severity": "<severity>",
        "provider_id": "<provider_id>",
        "ruleset_id": "<ruleset_id>",
        "ruleset_version": "<ruleset_version>",
        "rule_id": "<rule_id>",
        "checks": [
          {
            "message": "<message>",
            "targets": {} // List of targets, if the findings are from multiple instances this field can be presented as a map, where the keys are the names of the checked instances and the values are their targets
          }
        ]
      }
    },
    // list all other diki findings
  ]
}
```

To create the required `artefact-runtime` `CR` in the `ocm-gear` we can make a `PUT` request to the `/service-extensions/runtime-artefacts` endpoint of `delivery-service`.
The request body should look like:

``` json
{
  "artefacts": [
    {
      "component_name": "<component_name>",
      "component_version": "<component_version>",
      "artefact_kind": "runtime",
      "artefact": {
        "artefact_name": "<artefact_name>",
        "artefact_version": "diki",
        "artefact_type": "dikiReport"
      }
    }
  ]
}
```

## Cleanup

It is advised to remove old `Diki` findings from the `delivery database` and their `artefact-runtime` `CR`

To remove `Diki` findings from the `delivery database` we can make a `DELETE` request to the `/artefacts/metadata` endpoint of `delivery-service`.
The request body should contain the entries we want to delete.

To remove the `artefact-runtime` `CR` in the `ocm-gear` we can make a `DELETE` request to the `/service-extensions/runtime-artefacts` endpoint of `delivery-service`.
To specify which `artefact-runtime` remove we need to specify it in the query argument `name` in the request.
